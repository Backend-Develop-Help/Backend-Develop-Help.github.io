<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>RabbitMQ | 开发自救手册</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/img/favicon.ico">
    <script src="https://cdn.wwads.cn/js/makemoney.js" type="text/javascript"></script>
    <meta name="description" content="一本注重提升思维能力的开发自救手册。">
    <meta name="keywords" content="vuepress,theme,blog,vdoing">
    <meta name="theme-color" content="#11a8cd">
    <meta name="wwads-cn-verify" content="6c4b761a28b734fe93831e3fb400ce87">
    
    <link rel="preload" href="/assets/css/0.styles.9bcbf02c.css" as="style"><link rel="preload" href="/assets/js/app.f107c529.js" as="script"><link rel="preload" href="/assets/js/2.388f75b7.js" as="script"><link rel="preload" href="/assets/js/37.27191033.js" as="script"><link rel="prefetch" href="/assets/js/10.a3a8b7e9.js"><link rel="prefetch" href="/assets/js/11.3a4b3a6f.js"><link rel="prefetch" href="/assets/js/12.4b94c69a.js"><link rel="prefetch" href="/assets/js/13.0fc92fed.js"><link rel="prefetch" href="/assets/js/14.0e142cb8.js"><link rel="prefetch" href="/assets/js/15.52ed5af4.js"><link rel="prefetch" href="/assets/js/16.d7fb812a.js"><link rel="prefetch" href="/assets/js/17.b615de32.js"><link rel="prefetch" href="/assets/js/18.10aa16c6.js"><link rel="prefetch" href="/assets/js/19.891a786d.js"><link rel="prefetch" href="/assets/js/20.dc6a720f.js"><link rel="prefetch" href="/assets/js/21.d47ab2e2.js"><link rel="prefetch" href="/assets/js/22.d0bd460c.js"><link rel="prefetch" href="/assets/js/23.af8c6314.js"><link rel="prefetch" href="/assets/js/24.0b7170dd.js"><link rel="prefetch" href="/assets/js/25.996d2c16.js"><link rel="prefetch" href="/assets/js/26.31b97e81.js"><link rel="prefetch" href="/assets/js/27.9273c2dd.js"><link rel="prefetch" href="/assets/js/28.e2987f11.js"><link rel="prefetch" href="/assets/js/29.062c29f8.js"><link rel="prefetch" href="/assets/js/3.f554136f.js"><link rel="prefetch" href="/assets/js/30.8095effc.js"><link rel="prefetch" href="/assets/js/31.f0d92c2e.js"><link rel="prefetch" href="/assets/js/32.2a0247ac.js"><link rel="prefetch" href="/assets/js/33.9a1e6a1a.js"><link rel="prefetch" href="/assets/js/34.341333e7.js"><link rel="prefetch" href="/assets/js/35.3a407794.js"><link rel="prefetch" href="/assets/js/36.d75b1111.js"><link rel="prefetch" href="/assets/js/38.63d6e3be.js"><link rel="prefetch" href="/assets/js/39.3a70cb1f.js"><link rel="prefetch" href="/assets/js/4.aa385005.js"><link rel="prefetch" href="/assets/js/5.bb37d451.js"><link rel="prefetch" href="/assets/js/6.c033c22d.js"><link rel="prefetch" href="/assets/js/7.9d22425d.js"><link rel="prefetch" href="/assets/js/8.1e827847.js"><link rel="prefetch" href="/assets/js/9.9e0bffeb.js">
    <link rel="stylesheet" href="/assets/css/0.styles.9bcbf02c.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="开发自救手册" class="logo"> <span class="site-name can-hide">开发自救手册</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开发认知扩展" class="dropdown-title"><a href="/pages/4d70dc/" class="link-title">开发认知扩展</a> <span class="title" style="display:none;">开发认知扩展</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Java指南</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/1ba529/" class="nav-link">手册的初衷以及适用人群</a></li><li class="dropdown-subitem"><a href="/pages/4d70dc/" class="nav-link">介绍</a></li><li class="dropdown-subitem"><a href="/pages/f5ef63/" class="nav-link">JAVA涉及技术总览</a></li></ul></li><li class="dropdown-item"><h4>技术场景</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/b3dd9c/" class="nav-link">线上代码覆盖率监控</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="好文分享" class="dropdown-title"><a href="/pages/3001d9/" class="link-title">好文分享</a> <span class="title" style="display:none;">好文分享</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/3001d9/" class="nav-link">cpp自救指南</a></li><li class="dropdown-item"><!----> <a href="/pages/771788/" class="nav-link">go指南</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="面经&amp;分享" class="dropdown-title"><!----> <span class="title" style="display:;">面经&amp;分享</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/950801/" class="nav-link">真正的面经系列</a></li><li class="dropdown-item"><!----> <a href="/pages/940163/404" class="nav-link">经历分享</a></li><li class="dropdown-item"><h4>相关文章</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/88cd1f/" class="nav-link">25届实习内推</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="八股文" class="dropdown-title"><!----> <span class="title" style="display:;">八股文</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/771792/" class="nav-link">微服务</a></li></ul></div></div><div class="nav-item"><a href="/pages/daa40c/" class="nav-link">友情链接</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="参与分享" class="dropdown-title"><!----> <span class="title" style="display:;">参与分享</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/385249/" class="nav-link">团队介绍</a></li><li class="dropdown-item"><!----> <a href="/pages/c91501/" class="nav-link">如何加入</a></li></ul></div></div> <a href="https://github.com/Backend-Develop-Help/Backend-Develop-Help.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开发认知扩展" class="dropdown-title"><a href="/pages/4d70dc/" class="link-title">开发认知扩展</a> <span class="title" style="display:none;">开发认知扩展</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Java指南</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/1ba529/" class="nav-link">手册的初衷以及适用人群</a></li><li class="dropdown-subitem"><a href="/pages/4d70dc/" class="nav-link">介绍</a></li><li class="dropdown-subitem"><a href="/pages/f5ef63/" class="nav-link">JAVA涉及技术总览</a></li></ul></li><li class="dropdown-item"><h4>技术场景</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/b3dd9c/" class="nav-link">线上代码覆盖率监控</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="好文分享" class="dropdown-title"><a href="/pages/3001d9/" class="link-title">好文分享</a> <span class="title" style="display:none;">好文分享</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/3001d9/" class="nav-link">cpp自救指南</a></li><li class="dropdown-item"><!----> <a href="/pages/771788/" class="nav-link">go指南</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="面经&amp;分享" class="dropdown-title"><!----> <span class="title" style="display:;">面经&amp;分享</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/950801/" class="nav-link">真正的面经系列</a></li><li class="dropdown-item"><!----> <a href="/pages/940163/404" class="nav-link">经历分享</a></li><li class="dropdown-item"><h4>相关文章</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/88cd1f/" class="nav-link">25届实习内推</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="八股文" class="dropdown-title"><!----> <span class="title" style="display:;">八股文</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/771792/" class="nav-link">微服务</a></li></ul></div></div><div class="nav-item"><a href="/pages/daa40c/" class="nav-link">友情链接</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="参与分享" class="dropdown-title"><!----> <span class="title" style="display:;">参与分享</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/385249/" class="nav-link">团队介绍</a></li><li class="dropdown-item"><!----> <a href="/pages/c91501/" class="nav-link">如何加入</a></li></ul></div></div> <a href="https://github.com/Backend-Develop-Help/Backend-Develop-Help.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>微服务</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/771792/" class="sidebar-link">微服务介绍</a></li><li><a href="/pages/50142d/" class="sidebar-link">EureKa注册中心</a></li><li><a href="/pages/c95a2f/" class="sidebar-link">Ribbon负载均衡</a></li><li><a href="/pages/c321d3/" class="sidebar-link">Nacos注册中心、配置中心</a></li><li><a href="/pages/00990d/" class="sidebar-link">OpenFeign远程调用</a></li><li><a href="/pages/009d95/" class="sidebar-link">Gateway统一网关</a></li><li><a href="/pages/947d80/" class="sidebar-link">Docker</a></li><li><a href="/pages/s87jds/" class="sidebar-link">DockerCompose</a></li><li><a href="/pages/940163/" aria-current="page" class="active sidebar-link">RabbitMQ</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/940163/#同步通讯和异步通讯" class="sidebar-link">同步通讯和异步通讯</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/940163/#同步调用的问题" class="sidebar-link">同步调用的问题</a></li><li class="sidebar-sub-header level3"><a href="/pages/940163/#异步调用方案" class="sidebar-link">异步调用方案</a></li><li class="sidebar-sub-header level3"><a href="/pages/940163/#我的理解" class="sidebar-link">我的理解</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/940163/#什么是mq" class="sidebar-link">什么是MQ</a></li><li class="sidebar-sub-header level2"><a href="/pages/940163/#rabbitmq概述" class="sidebar-link">RabbitMQ概述</a></li><li class="sidebar-sub-header level2"><a href="/pages/940163/#常见消息模型" class="sidebar-link">常见消息模型</a></li><li class="sidebar-sub-header level2"><a href="/pages/940163/#springamqp-大大简化api" class="sidebar-link">SpringAMQP(大大简化api)</a></li><li class="sidebar-sub-header level2"><a href="/pages/940163/#workqueue-工作队列-模型" class="sidebar-link">WorkQueue 工作队列(模型)</a></li><li class="sidebar-sub-header level2"><a href="/pages/940163/#发布订阅模型介绍" class="sidebar-link">发布订阅模型介绍</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/940163/#发布订阅-fanout-exchange" class="sidebar-link">发布订阅-Fanout Exchange</a></li><li class="sidebar-sub-header level3"><a href="/pages/940163/#发布订阅-directexchange" class="sidebar-link">发布订阅-DirectExchange</a></li><li class="sidebar-sub-header level3"><a href="/pages/940163/#发布订阅-topicexchange" class="sidebar-link">发布订阅-TopicExchange</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/940163/#消息转换器" class="sidebar-link">消息转换器</a></li></ul></li><li><a href="/pages/384910/" class="sidebar-link">Sentinel微服务保护</a></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><span data-v-06225672>八股文</span></li><li data-v-06225672><span data-v-06225672>微服务</span></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="javascript:;" data-v-06225672>ethandu</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2024-04-27</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">RabbitMQ<!----></h1> <!----> <div class="theme-vdoing-content content__default"><h1 id="初识mq"><a href="#初识mq" class="header-anchor">#</a> 初识MQ</h1> <h2 id="同步通讯和异步通讯"><a href="#同步通讯和异步通讯" class="header-anchor">#</a> 同步通讯和异步通讯</h2> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220213224214526.png" alt="image-20220213224214526"></p> <h3 id="同步调用的问题"><a href="#同步调用的问题" class="header-anchor">#</a> 同步调用的问题</h3> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220213224605926.png" alt="image-20220213224605926"></p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220213224725874.png" alt="image-20220213224725874"></p> <p>每加一次需求代码都需要修改</p> <p>再加上是同步调用 用户必须等待订单服务完成才能执行仓储服务执行完才能执行短信服务 总耗时500ms很恐怖 性能太差</p> <p>在整个过程中有很多资源的浪费 要是卡住在仓储服务支付服务就渐渐被耗尽了</p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220213224950164.png" alt="image-20220213224950164"></p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220213225025676.png" alt="image-20220213225025676"></p> <p>总结：</p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220213225114871.png" alt="image-20220213225114871"></p> <h3 id="异步调用方案"><a href="#异步调用方案" class="header-anchor">#</a> 异步调用方案</h3> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220213225252153.png" alt="image-20220213225252153"></p> <p>优势一：服务解耦</p> <p>现在加需求就不需要再修改支付服务里面的代码 例如添加了优惠卷服务 因为我们呢现在支付服务不负责调用服务了 而是发消息 那么后面添加服务就只需要订阅事件就好了</p> <p>解除服务的话我们也就取消订阅就ok了</p> <p>优势二：性能提升，吞吐量提高</p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220213225623644.png" alt="image-20220213225623644"></p> <p>优势三：服务没有强依赖，不担心级联失败问题</p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220213225654961.png" alt="image-20220213225654961"></p> <p>优势四：流量消峰</p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220213225826285.png" alt="image-20220213225826285"></p> <p>总结：</p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220213225941732.png" alt="image-20220213225941732"></p> <h3 id="我的理解"><a href="#我的理解" class="header-anchor">#</a> 我的理解</h3> <p>传统的微服务调用用的是openFeign之类的通信手段，这个实际上在不对代码做处理的时候是同步的。</p> <p>但是我们的消息队列是可以声明“监听器”，监听到消息队列中有消息就执行业务逻辑的。这个实际上就是一种响应式的架构。不需要我们主动的去通信等待另一个微服务执行完毕，而是发个消息给消息队列，而微服务自己监听到消息就执行逻辑。</p> <p>这种响应式的架构实际上就是异步的，非阻塞的。快速的。</p> <h2 id="什么是mq"><a href="#什么是mq" class="header-anchor">#</a> 什么是MQ</h2> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220213230503194.png" alt="image-20220213230503194"></p> <h2 id="rabbitmq概述"><a href="#rabbitmq概述" class="header-anchor">#</a> RabbitMQ概述</h2> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220213230651293.png" alt="image-20220213230651293"></p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220213231023725.png" alt="image-20220213231023725"></p> <p>一般来说我创建一个用户他有自己的虚拟主机 然后我再创建一个用户他还是有一个虚拟主机 虚拟主机之间是相互隔离的互不干扰</p> <p>总结：</p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220213231145170.png" alt="image-20220213231145170"></p> <h2 id="常见消息模型"><a href="#常见消息模型" class="header-anchor">#</a> 常见消息模型</h2> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220213231317415.png" alt="image-20220213231317415"></p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220213231355226.png" alt="image-20220213231355226"></p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220214200232288.png" alt="image-20220214200232288"></p> <p>要向mq发送消息必须要和它先建立连接 用到连接工厂</p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220310215759080.png" alt="image-20220310215759080"></p> <p>这边有itcast的虚拟主机的访问权</p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220310215818996.png" alt="image-20220310215818996"></p> <p>创建通道</p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220310215932324.png" alt="image-20220310215932324"></p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220310215949632.png" alt="image-20220310215949632"></p> <p>有了通道可以向队列里面发送消息了</p> <p>那么我们需要的是创建一个队列</p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220310220104132.png" alt="image-20220310220104132"></p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220310220124657.png" alt="image-20220310220124657"></p> <p>生产者向队列里面发送消息</p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220310220114996.png" alt="image-20220310220114996"></p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220310220210879.png" alt="image-20220310220210879"></p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220310220230202.png" alt="image-20220310220230202"></p> <p>这个时候我们的发送者已经任务结束了 连接都断开了， 这样就解除耦合了 变成异步了</p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220310220356907.png" alt="image-20220310220356907"></p> <p>接收消息的是Consumer</p> <p>同样的是先创建连接</p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220310220828540.png" alt="image-20220310220828540"></p> <p>创建通道 创建队列(这里创建的原因是因为 我们的生产者和消费者启动的顺序是不确定的 万一消费者先启动找不到队列 )</p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220310220910809.png" alt="image-20220310220910809"></p> <p>然后就是接收消息了 里面的匿名内部类的对象的方法是我们的处理操作(handleDelivery) 我们把这个行为给挂在了队列上 一旦有消息它就会进行操作处理  最后一个参数byte[] body就是消息体</p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220310221130096.png" alt="image-20220310221130096"></p> <p>这是一个异步的机制，这行代码（接收到消息）在等待接收消息后面打印 该处理消息处理消息 我还是继续去执行我后面的业务去了</p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220310221608148.png" alt="image-20220310221608148"></p> <p>总结</p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220310221730227.png" alt="image-20220310221730227"></p> <h2 id="springamqp-大大简化api"><a href="#springamqp-大大简化api" class="header-anchor">#</a> SpringAMQP(大大简化api)</h2> <p>大大的简化我们的api</p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220310221844454.png" alt="image-20220310221844454"></p> <p><strong>AMQP: 是消息队列的规范</strong></p> <p>SpringAMQP：是Spring对AMQP的实现（就像是redis里面spring提供的模板）</p> <p>官网讲的特征：</p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220310222038096.png" alt="image-20220310222038096"></p> <p>SpringAMQP实现HelloWorld种的基础消息队列功能</p> <p>流程如下:</p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220310222214794.png" alt="image-20220310222214794"></p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220310222518608.png" alt="image-20220310222518608"></p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220310222543355.png" alt="image-20220310222543355"></p> <p>总结</p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220310222928585.png" alt="image-20220310222928585"></p> <p>子啊Consumer中编写消费逻辑，监听simple.queue 接收的是String类型的消息 将来都是Spring帮助我们完成任务 十分的优雅</p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220310223013568.png" alt="image-20220310223013568"></p> <p>总结</p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220310223424112.png" alt="image-20220310223424112"></p> <h2 id="workqueue-工作队列-模型"><a href="#workqueue-工作队列-模型" class="header-anchor">#</a> WorkQueue 工作队列(模型)</h2> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220310223600783.png" alt="image-20220310223600783"></p> <p>队列后面跟了两个消费者，消息将来给谁？</p> <p>rabbitmq中消息是阅后即焚</p> <p>消息一旦让消费者1消费了消费者2就肯定是拿不到了。</p> <p>两个消费者实际上是合作关系，共同处理。</p> <p>假设只有一个消费者，它的处理速度是：40条消息/s，但是发布者却每s发布了50条。这个就暂时是搞不定了，每s有10条消息多出来没人处理，就只能堆积在队列当中，队列在内存中是有存储上限的，这样下去一定会把队列给堆满，这样再有消息就进不去了。如果进不去，消息就会被丢弃，这样就出问题了。两个消费者，每s都处理40条消息的话之前的情况就是可以轻松应对了。</p> <p>所以WorkQueue实际上就还是普通的消息队列，只是挂了两个消费者。可以提高消息处理速度，避免队列消息堆积。</p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220512104256528.png" alt="image-20220512104256528"></p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220512105653155.png" alt="image-20220512105653155"></p> <p>消费者1消费的快，消费者2消费的慢，就少消费一点，毕竟能者多劳，但是我们现在是平均分布。这个并不是我们想要的。</p> <p>这个就是我们的消息预取机制。什么叫做消息预取？当我们大量的消息到达队列的时候队列会将消息进行投递，consumer1和consumer2的通道（channel）会把消息先拿过来，这个叫做消息预取。管他能不能处理，先拿过来再说，</p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220512105952141.png" alt="image-20220512105952141"></p> <p>这下就两边各自处理了50条消息了，于是两个人就平均分配了所有的消息，每个人25条，但是消费者1处理的快，很快搞定了，消费者2处理的慢，就花了很长时间才搞定</p> <p>消费预取限制：</p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220512110154593.png" alt="image-20220512110154593"></p> <p>我们这里就是预取1条消息，消费完成以后再去拿，不至于一下预取一大堆结果处理不完。</p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220512110719221.png" alt="image-20220512110719221"></p> <p>这个就起到了一个能者多劳的效果了。</p> <p>最后我们做一个总结：</p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220512110408528.png" alt="image-20220512110408528"></p> <p>这个模式可以提高整个队列的速度。</p> <p>这里我们发现在代码中创建队列或者交换机之类的也是非常简单(包括这些绑定交换机到队列之类的操作，都是可以在一个config类中解决的，只要将amqp包中的对象给注册到SpringIOC容器中就好了)</p> <div class="language-java extra-class"><pre class="language-java"><code>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FanoutConfig</span> <span class="token punctuation">{</span>
    <span class="token comment">// itcast.fanout</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">FanoutExchange</span> <span class="token function">fanoutExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FanoutExchange</span><span class="token punctuation">(</span><span class="token string">&quot;itcast.fanout&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// fanout.queue1</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">fanoutQueue1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token string">&quot;fanout.queue1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 绑定队列1到交换机</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">fanoutBinding1</span><span class="token punctuation">(</span><span class="token class-name">Queue</span> fanoutQueue1<span class="token punctuation">,</span> <span class="token class-name">FanoutExchange</span> fanoutExchange<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span>
                <span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>fanoutQueue1<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>fanoutExchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// fanout.queue2</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">fanoutQueue2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token string">&quot;fanout.queue2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 绑定队列2到交换机</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">fanoutBinding2</span><span class="token punctuation">(</span><span class="token class-name">Queue</span> fanoutQueue2<span class="token punctuation">,</span> <span class="token class-name">FanoutExchange</span> fanoutExchange<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span>
                <span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>fanoutQueue2<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span>fanoutExchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">objectQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token string">&quot;object.queue&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">simpleQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token string">&quot;simple.queue&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220512111013751.png" alt="image-20220512111013751"></p> <h2 id="发布订阅模型介绍"><a href="#发布订阅模型介绍" class="header-anchor">#</a> 发布订阅模型介绍</h2> <p>刚才我们的消息都是阅后即焚的（一旦消费完就会从队列中删除），这个就无法达到给多个消费者消费了。</p> <p>这个就无法满足我们课程开始时提出的需求：当用户支付完成了，你得去通知订单服务，仓储服务，短信服务。让这些服务各自去完成自己的业务。</p> <p>现在的消息要被3个服务都收到。</p> <p>那么就需要用到发布订阅模型了。实现方式实际上就是加上了一个交换机（exchange）。这个模型和计算机网络实际上是一样的。</p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220512111653755.png" alt="image-20220512111653755"></p> <p>这个模型我们不关心消费者怎么绑定。我们关心的是消息如何从发布者到达队列。</p> <p>消息发布到交换机，然后交换机将消息转发到队列当中。消息发布者不需要知道投递到队列的细节，这些都是交换机决定的，交换机转发消息给多个队列，这个就实现了我们的一份消息多个消费者消费的需求了！</p> <p>到底交换机是发送给一个还是多个呢？</p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220512112410933.png" alt="image-20220512112410933"></p> <p>exchange只负责转发，不管消息是否丢失，只有队列是存消息的。</p> <h3 id="发布订阅-fanout-exchange"><a href="#发布订阅-fanout-exchange" class="header-anchor">#</a> 发布订阅-Fanout Exchange</h3> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220512112559133.png" alt="image-20220512112559133"></p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220512112629997.png" alt="image-20220512112629997"></p> <p>SpringAMQP提供了声明交换机，队列，绑定关系的API，例如：</p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220512112642809.png" alt="image-20220512112642809"></p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220512112737269.png" alt="image-20220512112737269"></p> <p>连绑定都是需要声明的，利用BindingBuilder这个提供给我们的工厂。（绑定它（队列）到它（交换机））</p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220512112936808.png" alt="image-20220512112936808"></p> <p>这里我们是通过声明Bean的方式去写的。</p> <p>将来它读取到这些Bean以后就会帮我们，向rabbitmq去声明队列，交换机，绑定关系。全部都由Spring帮我们去做。</p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220512113155611.png" alt="image-20220512113155611"></p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220512113202359.png" alt="image-20220512113202359"></p> <p>交换机点到这个里面来，看到这个bindings</p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220512113227937.png" alt="image-20220512113227937"></p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220512113320885.png" alt="image-20220512113320885"></p> <p>队列就已经绑定上了。</p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220512113602086.png" alt="image-20220512113602086"></p> <p>这里以前是发送到队列，现在是发送到交换机。</p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220512113607932.png" alt="image-20220512113607932"></p> <p>然后发送消息，两个队列都收到了，这个就是fanout exchange</p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220512113506269.png" alt="image-20220512113506269"></p> <p>总结：</p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220512113649167.png" alt="image-20220512113649167"></p> <h3 id="发布订阅-directexchange"><a href="#发布订阅-directexchange" class="header-anchor">#</a> 发布订阅-DirectExchange</h3> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220512113724535.png" alt="image-20220512113724535"></p> <p>会将消息根据路由规则路由到指定的Queue</p> <p>这个也就被称为路由模式（routes）</p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220512113836463.png" alt="image-20220512113836463"></p> <p>我们现在两个队列都有自己的bindingkey了，将来发布者发送消息的时候也要指定一个RoutingKey</p> <p>这个时候Exchange将消息路由到队列的时候要比对bindingkey了。</p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220512114059766.png" alt="image-20220512114059766"></p> <p>这里要是我们发送的消息是bindingkey是red的话就和我们之前的fanoutexchange一样了，就都是广播了。</p> <p>所以我们可以用DirectExchange来模拟FanoutExchange，它比FanoutExchange更加灵活。这种灵活性也是有代价的，不要忘了在消息中加上bindingkey。</p> <p>这里我们不再使用Bean的方式来声明，毕竟需要声明这么多东西。</p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220512114502566.png" alt="image-20220512114502566"></p> <p>接下来就是基于@RabbitListener注解来声明这些组件。</p> <p>之前我们写的所有消费者当中都有这个注解。但是这个注解上可以同时完成队列和交换机的声明。不用再创建Bean了。</p> <p>（消费者实际上才是在代码中指定组件逻辑的，发布者只需要知道往哪个交换机or队列中发送消息就ok了）</p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220512114949567.png" alt="image-20220512114949567"></p> <p>这里我们原来在主键中写的是queues=...</p> <p>而这里我们是写bindings=@QueueBinding(...)</p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220512115154823.png" alt="image-20220512115154823"></p> <p>这样我们就完成了绑定的声明了，并且还声明了bindingkeys。</p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220512115330245.png" alt="image-20220512115330245"></p> <p>同样的代码copy一份来声明queue2到交换机的绑定。key为red,yellow</p> <p>这里多了一个exchange叫做itcast.direct，然后进去看到queue1绑定了什么，queue2绑定了什么key。</p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220512115449568.png" alt="image-20220512115449568"></p> <p>接着是消息发送的方法。</p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220512115730126.png" alt="image-20220512115730126"></p> <p>这下就blue就收到了。</p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220512115742285.png" alt="image-20220512115742285"></p> <h3 id="发布订阅-topicexchange"><a href="#发布订阅-topicexchange" class="header-anchor">#</a> 发布订阅-TopicExchange</h3> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220512115937546.png" alt="image-20220512115937546"></p> <p>这个模式和DirectExchange很像，但是routingkey必须是多个单词的列表，并且用.分割</p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220512120028961.png" alt="image-20220512120028961"></p> <p>左下角我们看到这个routingkey的逻辑实际上和话题的非常像</p> <p>那么我们去订阅的话，比如我想关系下新闻，中国的，日本的，那么我们得绑定两个key（在Direct中）。</p> <p>而在TopicExchange中我们支持通配符</p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220512120316353.png" alt="image-20220512120316353"></p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220512120332408.png" alt="image-20220512120332408"></p> <p>于是我们只要写china.#就可以收到所有的中国相关的话题。而我们写#.news就可以收到所有和新闻相关的话题。</p> <p>这个实际上就是简化了bindingkey的写法，原来用多个key的，现在只需要用一个key就可以了。</p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220512120538898.png" alt="image-20220512120538898"></p> <p>这下就写完成了</p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220512120637890.png" alt="image-20220512120637890"></p> <p>itcast.exchange</p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220512120742956.png" alt="image-20220512120742956"></p> <p>这里我们就可以测试这里的服务了。</p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220512120859547.png" alt="image-20220512120859547"></p> <p>这个变化也没有很大</p> <p>总结：</p> <p>这个bindingkey可以支持通配符。然后routingkey需要用.来分割单词列表。</p> <h2 id="消息转换器"><a href="#消息转换器" class="header-anchor">#</a> 消息转换器</h2> <p>我们在使用rabbitTemplate的时候消息这边接收的类一直是Object，这个说明我们可以发送任意的对象。</p> <p>先在config里面声明一个队列</p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220512121305170.png" alt="image-20220512121305170"></p> <p>然后我们测试发送一个对象</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">testSendObjectQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> msg<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        msg<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;pixel-revolve&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        msg<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;age&quot;</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">&quot;object.queue&quot;</span><span class="token punctuation">,</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
</code></pre></div><p>去到rabbitmq里面，我们看到消息，还有消息类型是java序列化类型。</p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220512121758594.png" alt="image-20220512121758594"></p> <p>它只支持字节。这种原生的序列化方式并不是那么好，性能差，安全性有问题，数据长度太长了，消息体越大，传输的效率也就越慢，而且还占用额外的内存空间。所以我们非常不推荐这种方式。</p> <p>Spring的消息对象处理使用MessageConverter来处理的。</p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220512122120971.png" alt="image-20220512122120971"></p> <p>我们使用jackson的方式来实现是比较喜欢的。</p> <p>同样的我们在consumer中引入jackson的依赖，并且定义一样的MessageConverter</p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220512122621498.png" alt="image-20220512122621498"></p> <p>这里我们就接收到了，这个方式就是比较方便的</p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220512122543082.png" alt="image-20220512122543082"></p> <p>总结：</p> <p><img src="/img/ethandu/%E5%BE%AE%E6%9C%8D%E5%8A%A1/SpringCloud+%E5%BE%AE%E6%9C%8D%E5%8A%A1.assets/image-20220512122722144.png" alt="image-20220512122722144"></p></div></div> <!----> <div class="page-edit"><!----> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2024/05/02, 13:47:32</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/s87jds/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">DockerCompose</div></a> <a href="/pages/384910/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">Sentinel微服务保护</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/s87jds/" class="prev">DockerCompose</a></span> <span class="next"><a href="/pages/384910/">Sentinel微服务保护</a>→
      </span></p></div></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="https://github.com/Backend-Develop-Help/Backend-Develop-Help.github.io" title="GitHub" target="_blank" class="iconfont icon-github"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2019-2024
    <span>Backend Development | MIT License</span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.f107c529.js" defer></script><script src="/assets/js/2.388f75b7.js" defer></script><script src="/assets/js/37.27191033.js" defer></script>
  </body>
</html>
